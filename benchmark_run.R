setwd()
source("R/functions.R")

########################################wl######################################
#Description: Relabel each patient's outcome (Y_c, Y_P) to corresponding \omega_l

#Input: 
#sim_col - vector of patient's (Y_c, Y_P) outcome

#Output; Numeric; \omega_l value

wl<- function(sim_col){
  test<-c()
  if(sum(sim_col==c(0,0))==2){
    test<-0
  }
  if(sum(sim_col==c(1,0))==2){
    test<-1
  }
  if(sum(sim_col==c(0,1))==2){
    test<-2
  }
  if(sum(sim_col==c(1,1))==2){
    test<-3
  }
  return(test)
}

#########################Generate table#########################################
#Description: Generate table of estimates \pi_l(d) as presented in Table 4 of the manuscript

#Input:
#no.sim.table - number of simulations to estimate all pi_l(d) 
#phi - correlation parameter
#true_tox_p - true C-DLT rate under the simulation scenario
#rue_tox_p - true P-DLT rate under the simulation scenario

#Output: Matrix containing with dth column containing estimate of \pi_l(d) for each possible \omega_l  

generate_table<- function(no.sim.table, phi, true_tox_c, true_tox_p){
  table<- matrix(nrow=4, ncol=6)
  table[,1]<- 0:3
  for(j in 1:5){
    sim<-sapply(rep(phi, times=no.sim.table), function (k) time_to_dlt(j,true_tox_c,true_tox_p, k))<=1
    sim[1,]<- as.numeric(sim[1,])
    wl_values<-sapply(1:no.sim.table, function(k) wl(sim[,k]))
    for(i in 0:3){
      table[i+1, j+1]<- sum(wl_values>=(i))/no.sim.table
    }
  }
  return(table)
}

##############################patient_outcome##################################
#Description: \omega_l outcome for patient i for a specific dose

#Input: 
#dose - Dose patient i treated with 
#uniform - Vector of uniform R.Vs for patient i at each dose
#Probability table - matrix of \pi_l(d) as generated by function generate_table

#Output - Numeric; \omega_l for patient i treated at a specific dose

patient_outcome<- function(dose, uniform, probability_table){
  part1<-c()
  part2<-c()
  for(i in 1:4){
    part1[i]<-ifelse(i<4, uniform[i]> probability_table[i+1, dose+1]/probability_table[i, dose+1], TRUE)
    part2[i]<-ifelse(i>1, uniform[i-1] <= probability_table[i, dose+1]/probability_table[i-1, dose+1], uniform[i] <= probability_table[i, dose+1])
  }
  return(w[min(which(part1&part2 == TRUE))])
}

#####################################estimate_pi_lk###############################
#Description: Estimate of \hat{\pi}_l(d) for each dose d

#Input: 
# l - l used to define \omega_l
# dose - Dose patient i treated with 
# unif - Matrix (axb) of uniform R.Vs for a patients across b doses
#probability_table- matrix of \pi_l(d) as generated by function generate_table

#Output - Numeric; Estimate of \hat{\pi}_l(d)

estimate_pi_lk<- function(l, dose, unif, probability_table){
  n<-nrow(unif)
  ui1<- (unif[,1] <= probability_table[2, dose+1])
  ui2<- ui1 & (unif[,2] <= (probability_table[3, dose+1])/(probability_table[2, dose+1]))
  ui3<- ui2 & (unif[,3] <= (probability_table[4, dose+1])/(probability_table[3, dose+1]))
  vec_ind<- list(ui1, ui2, ui3)
  est<-(1/n)*sum(vec_ind[[l]])
  return(est)
} 

###############################estimate_cp_dlt##################################
#Description: Estimated rate of C-DLT and P-DLT to confirm accuracy of benchmark 

#dosage - dose of interest 
#unif_pat - atrix (axb) of uniform R.Vs for a patients across b doses
#prob_table - matrix of \pi_l(d) as generated by function generate_table

#Output: Numeric; estimate of C-DLT and P-DLT rate for dose d

estimate_cp_dlt<- function(dosage, unif_pat, prob_table){
  w0<-1-estimate_pi_lk(1, dosage, unif_pat, prob_table)
  w1<- estimate_pi_lk(1, dosage, unif_pat, prob_table)-estimate_pi_lk(2, dosage, unif_pat, prob_table)
  w2<- estimate_pi_lk(2, dosage, unif_pat, prob_table)-estimate_pi_lk(3, dosage, unif_pat, prob_table)
  w3<- estimate_pi_lk(3, dosage, unif_pat, prob_table)
  return(c(w1+w3, w2+w3))
}

################################benchmark_trial_sim###############################
#Description: Dose recommended following the enrollment of patients in a trial with complete information 

#Input: 
# alpha - alpha used to define the utility curve 
#sample - overall sample size of trial 
#table_of_probabilities - matrix of \pi_l(d) as generated by function generate_table
#target_clin - target C-DLT rate 
#target_pat - target P-DLT rate 

benchmark_trial_sim<- function(alpha, sample, table_of_probabilities, target_clin, target_pat){
  u_pat<-matrix(runif(3*sample), nrow=sample)
  est<-sapply(1:5, function (k) estimate_cp_dlt(k, u_pat, table_of_probabilities))
  rec_dose<-which.min(mapply(function(p,c) optimise(distance, c(0,target_pat), alpha=alpha, pred_x= p, pred_y=c, patient_target_DLT=target_pat, clinician_target_DLT=target_clin)$objective, p=est[2,], c=est[1,]))
  return(rec_dose)
}

#########################SIMULATION SET UP #############################################



true_tox_clin<- rbind.data.frame(c(0.05, 0.05, 0.25, 0.4, 0.55), c(0.05, 0.25, 0.40, 0.55, 0.7), c(0.01, 0.02, 0.05, 0.10, 0.25),
                                 c(0.02, 0.05, 0.1, 0.25, 0.4), c(0.05, 0.1, 0.16, 0.25, 0.4), c(0.05, 0.18, 0.2, 0.25, 0.4), 
                                 c(0.01, 0.05, 0.1, 0.16, 0.25),c(0.25, 0.40, 0.55, 0.7, 0.8), c(0.45, 0.50, 0.55, 0.7, 0.8))
dimnames(true_tox_clin)[[2]]<- c( "1","2", "3", "4", "5")
dimnames(true_tox_clin)[[1]]<- c("Sc 1", "Sc 2", "Sc 3", "Sc 4", "Sc 5", "Sc 6", "Sc 7", "Sc 8", "Sc 9")                        

true_tox_pro<- rbind.data.frame(c(0.17, 0.18, 0.35, 0.50, 0.65), c(0.1, 0.15, 0.35, 0.5, 0.65), c(0.04, 0.09, 0.17, 0.2, 0.35),
                                c(0.09, 0.17, 0.2, 0.35, 0.5), c(0.05, 0.2, 0.35, 0.5, 0.65), c(0.17, 0.35, 0.5, 0.65, 0.8),
                                c(0.04, 0.05, 0.2, 0.35, 0.5),c(0.35, 0.5, 0.65, 0.8, 0.85), c(0.55, 0.6, 0.65, 0.8, 0.85))
dimnames(true_tox_pro)[[2]]<- c( "1","2", "3", "4", "5")
dimnames(true_tox_pro)[[1]]<- c("Sc 1", "Sc 2", "Sc 3", "Sc 4", "Sc 5", "Sc 6", "Sc 7","Sc 8", "Sc 9") 


phi<- 0.1
alpha<- 15
sample_size<- 39
number_sim_table<- 10000
number_sim_bench<- 1000
target_c<- 0.25
target_p<- 0.35
all_sc<- NULL
for(i in 1:9){
  clin_true_tox<- as.numeric(true_tox_clin[i,])
  pat_true_tox<- as.numeric(true_tox_pro[i,])
  table<-generate_table(number_sim_table, phi, clin_true_tox, pat_true_tox)
  rec<-sapply(rep(alpha, times=number_sim_bench), function (n) benchmark_trial_sim(n, sample_size, table, target_c, target_p))
  prob_dlt<- c(sum(rec==1,na.rm=TRUE)/number_sim_bench, sum(rec==2,na.rm=TRUE)/number_sim_bench, sum(rec==3,na.rm=TRUE)/number_sim_bench, sum(rec==4,na.rm=TRUE)/number_sim_bench, sum(rec==5,na.rm=TRUE)/number_sim_bench)
  sc<-rbind.data.frame(clin_true_tox, pat_true_tox, prob_dlt)
  dimnames(sc)[[2]]<- c( "1","2", "3", "4", "5")
  dimnames(sc)[[1]]<- c("Probability of clinician DLT", "Probability of patient DLT", "Probability recommended as MTD")
  all_sc<-rbind.data.frame(all_sc, sc)
  write.csv(all_sc, paste0(alpha, "benchmark1_simulation_",phi,".csv"))
}

all_sc<- NULL
alpha<- 2
for(i in 1:9){
  clin_true_tox<- as.numeric(true_tox_clin[i,])
  pat_true_tox<- as.numeric(true_tox_pro[i,])
  table<-generate_table(number_sim_table, phi, clin_true_tox, pat_true_tox)
  rec<-sapply(rep(alpha, times=number_sim_bench), function (n) benchmark_trial_sim(n, sample_size, table, target_c, target_p))
  prob_dlt<- c(sum(rec==1,na.rm=TRUE)/number_sim_bench, sum(rec==2,na.rm=TRUE)/number_sim_bench, sum(rec==3,na.rm=TRUE)/number_sim_bench, sum(rec==4,na.rm=TRUE)/number_sim_bench, sum(rec==5,na.rm=TRUE)/number_sim_bench)
  sc<-rbind.data.frame(clin_true_tox, pat_true_tox, prob_dlt)
  dimnames(sc)[[2]]<- c( "1","2", "3", "4", "5")
  dimnames(sc)[[1]]<- c("Probability of clinician DLT", "Probability of patient DLT", "Probability recommended as MTD")
  all_sc<-rbind.data.frame(all_sc, sc)
  write.csv(all_sc, paste0(alpha, "benchmark1_simulation_",phi,".csv"))
}


